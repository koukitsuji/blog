---
title: "ブログへGoogleアナリティクスを導入する方法"
date: 2020-05-26T21:19:35+09:00
slug: analytics
draft: true

# post thumb
image: "logo.jpg"

# meta description
description: "Google アナリティクスをブログに設定します。メインドメインとサブドメインを１つのサイトとして計測するため、クロスドメイン設定を行っています。"

# taxonomies
categories:
  - "Programming"
tags:
  - "Hugo"
  - "Blog"

# post type
type: "post"
---



# はじめに



Google アナリティクスをブログに設定します。

メインドメインとサブドメインを１つのサイトとして計測するため、クロスドメイン設定を行っています。



## この記事でやること



* Google アナリティクスの設定
* Google タグマネージャーを用いて、クロスドメインの設定
* クロスドメインは、メインドメインの``kouki.io``と、サブドメインの``blog.kouki.io``の2つを用いる



## 開発環境

* Mac OS: Mojave 10.14.6



# Google アナリティクスの設定

Google アナリティクスの設定を行います。

ここは基本的に、公式の[アナリティクスのスタートガイド](https://support.google.com/analytics/answer/1008015?hl=ja&ref_topic=3544906)を参照しています。

まず、[Google アナリティクス](http://www.google.co.jp/analytics/)へアクセスし、アカウントを作成 or ログインします。

``[管理] - [アカウントの列] - [アカウントを作成]``を選択します（ここでは新しく作成しますが、既にブログ用のものを作成済みならスキップ）。



![1](1.jpg)



測定の対象は「ウェブ」を選択。



![2](2.jpg)





プロパティの設定にて、ウェブサイトの名称などを設定します。

ウェブサイトのURLは、メインドメインの方を設定します。

業種は、目標を設定する際のテンプレートが変わります。技術ブログで訪問者は注文など行動をしませんし、とりあえずはページビューだけ計測できればいいので、今回は「その他」を選択しています。あとから変更可能ですので適当に。



![3](3.jpg)



作成が完了すると、以下のようにプロパティまで作成できていることがわかります。

最後に、トラッキングIDをメモしておきます。``[プロパティ] - [トラッキング情報] - [トラッキングコード]``へアクセスします。



![4](4.jpg)



この``UA-XXXXXXXXX-X``がトラッキングコードです。



![5](5.jpg)



ここで、いったんアナリティクスでの作業は終了です。





# Googleタグマネージャーの設定



Google アナリティクスを導入する際は、Google タグマネージャーを利用する方がよいでしょう。

Google タグマネージャーは、タグと呼ばれるトラッキングコードなどを簡単に管理できるシステムです。

Google タグマネージャーでは、Google アナリティクスタグやGoogle広告タグなどを「コンテナ」にひとまとめにして一元管理することが可能です。

Webサイトへタグマネージャをインストールしておくと、後から新しいタグを追加したい場合にも、Webサイトの更新なしでタグの追加が行えるため、メンテナンスが非常に簡単になります（非導入の場合は、それぞれのタグをWebサイトへ直接埋め込む必要があります）。

公式の[タグ マネージャーで Google アナリティクスを導入する](https://support.google.com/tagmanager/answer/6107124)や[ドメイン全体のアクティビティを測定する](https://support.google.com/tagmanager/answer/6164469?visit_id=637260539544122047-74676773&rd=1)を参照にします。

まず、[Google タグマネージャー](https://tagmanager.google.com/)へアクセスし、アカウントを作成 or ログインします。

その後、``アカウントを作成``します。



![6](6.jpg)



アカウント名などを設定します。

コンテナの設定では「ウェブ」を選択します。



![7](7.jpg)



作成が完了したら、``[タグ] - [新規]``で新たにタグを作成します。



![8](8.jpg)



タグのタイプは「ユニバーサル　アナリティクス」を選択します。

![9](9.jpg)

``[Google アナリティクス設定] - [新しい変数...]``を選択。

![10](10.jpg)



変数の設定で、以下のように設定します。

これらは、「双方向のクロスドメイン」を実装するために必要な設定です。詳細は後述します。

| 項目            | 値                                                  |
| --------------- | --------------------------------------------------- |
| トラッキングID  | 先ほど設定したGoogle アナリティクスのトラッキングID |
| Cookie ドメイン | auto                                                |



[その他の設定] - [設定するフィールド]

| フィールド名 | 値   |
| ------------ | ---- |
| allowLinker  | true |



[その他の設定] - [クロスドメイン トラッキング]

| 項目               | 値                                         |
| ------------------ | ------------------------------------------ |
| 自動リンクドメイン | メインドメインとサブドメインをコンマ区切り |



![11](11.jpg)



これで保存をします。

最後に、トリガーの設定です。

今回はページビューを設定するので、デフォルトで存在する「All Pages」を設定しておきます。



![12](12.jpg)







## 余談

Google タグマネージャーで設定した各パラメータについて説明します。

これらは、双方向のクロスドメインを実装するために必要な設定です。



 ### Cookie ドメイン

``Cookie ドメイン``を``auto``に設定すると、ドメインAからドメインBへ移動する際、自動的に最適なドメインにCookieが発行されます。

具体的には、``blog.kouki.io``というサブドメインにアクセスした際、可能な限り上位のドメイン``kouki.io``にCookieドメインが設定されます。

これにより、異なるドメインでも、訪問者が同一のユーザーとして識別され、クロスドメインを設定したサイトにおいてアクセスのダブルカウントを防ぐことが可能となります。



（参考）[Google アナリティクス公式 - Cookieとユーザーの識別](https://developers.google.com/analytics/devguides/collection/analyticsjs/cookies-user-id?hl=ja)

（参考）[CodeZine - Googleアナリティクスの計測の仕組みを理解しよう](https://codezine.jp/article/detail/9909)



### リンカー

フィールドとして設定した``allowLinker``を``true``にすると、クロスドメインのリンカーパラメータの解析が可能となります。

クロスドメインを設定するには必要な設定です。



（参考）[Google アナリティクス公式 - リンカー](https://developers.google.com/analytics/devguides/collection/analyticsjs/linker?hl=ja)

（参照）[Google アナリティクス公式 - クロスドメイン トラッキングを設定する（analytics.js）](https://support.google.com/analytics/answer/1034342)

（参照）[Google アナリティクス公式 - タグ マネージャーで Google アナリティクスを導入する](https://support.google.com/tagmanager/answer/6107124)


### 自動リンクドメイン

クロスドメインを設定するドメインAとドメインBにおいて、AからBの移動、BからAの移動のどちらもありえる場合は、双方向のクロスドメインの設定が必要です。

この項目にコンマ区切りでドメインをリストすることで、これらのドメイン間の移動において、お互いにソース（移動元）とリンク先として機能することが可能となります。

つまり、双方向のクロスドメインが実装できます。

（参考）同上





# Google アナリティクスの設定2



もう一度こちらに戻って設定が必要です。



## フィルタの設定

Googleアナリティクスにおいて、``https://tmp.com/index``にアクセスした際、以下のような情報を得ます。

| ホスト名 | リクエストURI |
| -------- | ------------- |
| tmp.com  | /index        |

そして、Googleアナリティクスがレポートとして表示するのは「リクエストURI」のみです。

つまり、以下の2つのサイトでクロスドメイン設定した場合、

| アクセスするURL           | ホスト名    | リクエストURI |
| ------------------------- | ----------- | ------------- |
| https://tmp.com/index     | tmp.com     | /index        |
| https://sub.tmp.com/index | sub.tmp.com | /index        |

「リクエストURI」が同じとなり、異なるページでも同一のものとして集計されてしまいます。

これを防ぐための設定を行います。

Google アナリティクスの``[管理] - [設定したアカウント] - [設定したプロパティ] - [フィルタ]``へアクセス。



![13](13.jpg)



以下のように設定。



| 項目                 | 値                        |
| -------------------- | ------------------------- |
| フィルタ名           | 任意                      |
| フィルタの種類       | カスタム、詳細            |
| フィールドA -> 引用A | ホスト名、``(.*)``        |
| フィールドB -> 引用B | リクエストURI、``(.*)``   |
| 出力先 -> 構成       | リクエストURI、``$A1$B1`` |



![14](14.jpg)



![15](15.jpg)



これで、上記のようなケースでも別々に集計され、レポートでも別々に表示されるようになります。



## 参照元除外リストの設定



クロスドメイン測定が正常に機能するためには、すべてのドメインを「参照元除外リスト」へ設定する必要があります。

Google アナリティクスのレポートでは、サイトへのアクセスの参照元を集計できます。

Twitterに流したリンクからのアクセスなのか、Google検索からのトラフィックなのか、などですね。

クロスドメインを設定している場合、クロスドメイン内の移動をカウントするとおかしなことになるので、それをカウントさせないようにします。

``[設定したアカウント] - [設定したプロパティ] - [トラッキング情報] - [参照元除外リスト]``へアクセスします。



![16](16.jpg)



クロスドメインに設定したドメインを追加します。



![17](17.jpg)





# Webサイトへインストール



[Google タグマネージャー](https://tagmanager.google.com/)へアクセスし、``[管理] - [Google タグマネージャーをインストール]``より、指示通りにコードを貼り付けます。



![18](18.jpg)



![19](19.jpg)



Hugoでは、テンプレートを用いて全ページに導入が可能です。

Hugoでのインストール方法は別記事にまとめます。

それ以外は、各自お好みの方法でインストールしましょう。



# デプロイ



Google タグマネージャーの設定をデプロイします。

右上の「プレビュー」クリックし、図のようにプレビューモードの起動を確認します。



![20](20.jpg)



この状態で、ブラウザでクロスドメインに設定したWebサイトへアクセスすると、以下のようなウィンドウが自動で開きます。

（開かない場合は、WebサイトへのGoogle タグマネージャーのインストールなどがミスってるかもです）



![21](21.jpg)



この中を見ると、いろいろな情報がわかります。

下の画像では、Google タグマネージャーのコンテナID（右上灰色塗りつぶし部）や、Google アナリティクスのトラッキングID（下部灰色塗りつぶし部）、Google タグマネージャの変数で設定したフィールドなど（赤枠）がちゃんと反映されていることが確認できます。



![22](22.jpg)



いい感じなことが確認できたら、Google タグマネージャーへ戻り、「プレビューモードを終了」して「公開」します。



![23](23.jpg)



バージョン名や説明を適当に埋め、「公開」しましょう。

数時間放置したあとに再度アクセスすると、アクセス解析のレポートを確認できるようになります。



以上で設定は終了です。